<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å¾·åœ°å›¾è½¨è¿¹åŠ¨ç”»ï¼ˆåŸºäºå†å²æ•°æ®ï¼‰</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* Internet Explorer/Edge */
            user-select: none;         /* Standard */
        }
        #mapContainer {
            width: 100%;
            height: 100vh;
        }
        .control-panel {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            width: -webkit-max-content; /* Safari/Chrome */
            width: -moz-max-content;    /* Firefox */
            width: max-content;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #speedControl {
            width: 100px;
            vertical-align: middle;
            -webkit-appearance: none;
            height: 5px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        #speedControl::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        #speedControl:hover {
            opacity: 1;
        }
        .speed-label {
            font-size: 14px;
            color: #333;
        }
        .status-message {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.75);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            z-index: 200;
            display: none;
            font-size: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            white-space: pre-wrap; /* å…è®¸æ¢è¡Œ */
            text-align: center;
        }
        .amap-info-outer {
            background: transparent !important; /* ä½¿ä¿¡æ¯çª—å£èƒŒæ™¯å®Œå…¨é€æ˜ */
            border: none !important; /* ç§»é™¤é»˜è®¤è¾¹æ¡† */
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* ä¿ç•™é˜´å½± */
            border-radius: 5px;
        }
        .amap-info-close {
            top: 8px !important;
            right: 8px !important;
        }
    </style>
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾API -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=2f28a8c7d7ddfec8ebdcdff2a977f9bb&plugin=AMap.ToolBar,AMap.Scale,AMap.GeometryUtil"></script>
</head>
<body>
    <div id="mapContainer"></div>
    <div class="control-panel">
        <button id="startBtn" onclick="startAnimation()">å¼€å§‹</button>
        <button id="pauseBtn" onclick="pauseAnimation()" disabled>æš‚åœ</button>
        <button id="resetBtn" onclick="resetAnimation()" disabled>é‡ç½®</button>
        <span class="speed-label">é€Ÿåº¦ï¼š</span>
        <input type="range" id="speedControl" min="0.5" max="3" step="0.1" value="1" aria-label="åŠ¨ç”»é€Ÿåº¦æ§åˆ¶">
        <span id="speedValue">1.0x</span>
    </div>
    <div id="statusMessage" class="status-message"></div>

    <script>
        // é«˜å¾·APIå¯†é’¥
        const AMapKey = '2f28a8c7d7ddfec8ebdcdff2a977f9bb';

        // 1. ä½ çš„åœ°å€æ•°æ®ï¼ˆæ¥æºäºaddress_cache.csv å’Œ dynamic_trajectory.py çš„æ—¥æœŸï¼‰
        // æŒ‰ç…§ dynamic_trajectory.py ä¸­çš„åŸå§‹é¡ºåºå’Œæ—¥æœŸï¼Œç»“åˆ address_cache.csv ä¸­çš„ç»çº¬åº¦
        const locationData = [
            {"address": "æµ™æ±Ÿçœæ¹–å·å¸‚", "date_str": "3.16", "lat": 30.894178, "lng": 120.086881},
            {"address": "æ¹–å·å¸‚å¾·æ¸…å¿", "date_str": "3.16", "lat": 30.54251, "lng": 119.9774},
            {"address": "å®‰å¾½çœæ·®å—å¸‚", "date_str": "3.17", "lat": 32.585384, "lng": 117.018603},
            {"address": "æ·®å—å¸‚è°¢å®¶é›†åŒº", "date_str": "3.18", "lat": 32.599173, "lng": 116.860026},
            {"address": "æ·®å—å¸‚å…«å…¬å±±åŒº", "date_str": "3.19", "lat": 32.630922, "lng": 116.832979},
            {"address": "æ²³å—çœè®¸æ˜Œå¸‚", "date_str": "3.20", "lat": 34.03732, "lng": 113.852004},
            {"address": "è®¸æ˜Œå¸‚ç¦¹å·å¸‚", "date_str": "3.21", "lat": 34.142442, "lng": 113.488715},
            {"address": "ç¦¹å·å¸‚å…¬å®‰å±€å°å•æ´¾å‡ºæ‰€", "date_str": "3.22", "lat": 34.052739, "lng": 113.474547},
            {"address": "ç¦¹å·å¸‚å…¬å®‰å±€é¢–å·æ´¾å‡ºæ‰€", "date_str": "3.23", "lat": 34.14769, "lng": 113.486725},
            {"address": "é™•è¥¿çœæ¸­å—å¸‚", "date_str": "3.24", "lat": 34.520632, "lng": 109.470962},
            {"address": "æ¸­å—å¸‚åé˜´å¸‚", "date_str": "3.24", "lat": 34.566552, "lng": 110.092286},
            {"address": "æ²³å—çœæ´›é˜³å¸‚", "date_str": "3.24", "lat": 34.619702, "lng": 112.453895},
            {"address": "æ´›é˜³å¸‚æ ¾å·", "date_str": "3.24", "lat": 33.7857, "lng": 111.615729},
            {"address": "å®æ³¢å¸‚å¥‰åŒ–åŒº", "date_str": "3.27", "lat": 29.655292, "lng": 121.406151},
            {"address": "å®‰å¾½çœæ± å·å¸‚", "date_str": "4.14", "lat": 30.674264, "lng": 117.495663},
            {"address": "æ± å·å¸‚çŸ³å°å¿", "date_str": "4.15", "lat": 30.210218, "lng": 117.486211},
            {"address": "æ± å·å¸‚é’é˜³å¿", "date_str": "4.16", "lat": 30.639006, "lng": 117.847366},
            {"address": "æ± å·å¸‚ä¸œè‡³å¿", "date_str": "4.17", "lat": 30.111182, "lng": 117.027533},
            {"address": "å®‰å¾½çœå…­å®‰å¸‚", "date_str": "4.18", "lat": 31.735892, "lng": 116.519729},
            {"address": "å…­å®‰å¸‚é‡‘å®‰åŒº", "date_str": "4.19", "lat": 31.75014, "lng": 116.539458},
            {"address": "å®‰å¾½çœå®£åŸå¸‚", "date_str": "4.20", "lat": 30.939278, "lng": 118.759127},
            {"address": "å®£åŸå¸‚å®å›½å¸‚", "date_str": "4.21", "lat": 30.634032, "lng": 118.983085},
            {"address": "æ¹–åŒ—çœå®œæ˜Œå¸‚", "date_str": "4.22", "lat": 30.69217, "lng": 111.286962},
            {"address": "æ¹–åŒ—çœæ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·", "date_str": "4.23", "lat": 30.272104, "lng": 109.488076},
            {"address": "æ©æ–½å±¯å ¡æ´¾å‡ºæ‰€", "date_str": "4.24", "lat": 30.335368, "lng": 109.336014},
            {"address": "æ¹–åŒ—çœå®œæ˜Œå¸‚", "date_str": "4.25", "lat": 30.69217, "lng": 111.286962},
            {"address": "å®œæ˜Œå¸‚ç§­å½’å¿", "date_str": "4.26", "lat": 30.825882, "lng": 110.97793},
            {"address": "ç§­å½’å¿èŒ…åªæ´¾å‡ºæ‰€", "date_str": "4.27", "lat": 30.823078, "lng": 110.97344},
            {"address": "æ±Ÿè¥¿çœæ™¯å¾·é•‡å¸‚", "date_str": "4.28", "lat": 29.2744, "lng": 117.184892},
            {"address": "æ™¯å¾·é•‡å¸‚æµ®ç²±å¿", "date_str": "4.29", "lat": 29.352493, "lng": 117.214984},
            {"address": "å®‰å¾½çœå®£åŸå¸‚å®å›½å¸‚", "date_str": "4.30", "lat": 30.634032, "lng": 118.983085},
            {"address": "é‡åº†æ²™åªååŒº", "date_str": "5.12", "lat": 29.541017, "lng": 106.456939},
            {"address": "åŒç¢‘æ´¾å‡ºæ‰€", "date_str": "5.13", "lat": 28.297521, "lng": 104.169907},
            {"address": "é‡åº†æ²™åªååŒºçœ‹å®ˆæ‰€", "date_str": "5.14", "lat": 29.541017, "lng": 106.456939},
            {"address": "æµ™æ±Ÿçœä¸½æ°´å¸‚", "date_str": "5.23", "lat": 28.467694, "lng": 119.923249},
            {"address": "ä¸½æ°´å¸‚è²éƒ½åŒº", "date_str": "5.24", "lat": 28.4461, "lng": 119.912266},
            {"address": "ä¸½æ°´å¸‚äº‘å’Œå¿", "date_str": "5.25", "lat": 28.116024, "lng": 119.573454},
            {"address": "ç¦å»ºçœæ³‰å·å¸‚", "date_str": "5.28", "lat": 24.874452, "lng": 118.675724},
            {"address": "æ³‰å·å¸‚æ™‹æ±Ÿå¸‚", "date_str": "5.30", "lat": 24.781635, "lng": 118.551659},
            {"address": "æ¸©å²­å¸‚æ¾é—¨æ´¾å‡ºæ‰€", "date_str": "6.4", "lat": 28.349231, "lng": 121.590071},
            {"address": "æ¸©å²­å¸‚å¤ªå¹³æ´¾å‡ºæ‰€", "date_str": "6.5", "lat": 28.372805, "lng": 121.385435},
            {"address": "æ¸©å²­å¸‚æ³½å›½æ´¾å‡ºæ‰€", "date_str": "6.6", "lat": 28.454333, "lng": 121.348728},
            {"address": "ä¸½æ°´å¸‚è²éƒ½åŒº", "date_str": "6.16", "lat": 28.4461, "lng": 119.912266},
            {"address": "ä¸½æ°´å¸‚äº‘å’Œå¿", "date_str": "6.19", "lat": 28.116024, "lng": 119.573454},
            {"address": "ç¦å»ºçœç¦å·å¸‚", "date_str": "6.22", "lat": 26.074286, "lng": 119.296411},
            {"address": "ç¦å·å¸‚æ°¸æ³°å¿", "date_str": "6.23", "lat": 25.867198, "lng": 118.932746},
            {"address": "ç¦å·å¸‚ä»“å±±åŒº", "date_str": "6.24", "lat": 26.047027, "lng": 119.27322},
            {"address": "ä»“å±±åŒºé‡‘å±±æ´¾å‡ºæ‰€", "date_str": "6.25", "lat": 26.042116, "lng": 119.264007},
            {"address": "ç¦å»ºçœæ³‰å·å¸‚", "date_str": "6.26", "lat": 24.874452, "lng": 118.675724},
            {"address": "æ³‰å·å¸‚æ°¸æ˜¥å¿", "date_str": "6.27", "lat": 25.321849, "lng": 118.29416},
            {"address": "æ°¸æ˜¥å¿ä¸œå¹³æ´¾å‡ºæ‰€", "date_str": "6.28", "lat": 25.3036, "lng": 118.341181},
            {"address": "ç¦å»ºçœå—å¹³å¸‚", "date_str": "6.29", "lat": 27.382829, "lng": 118.081325},
            {"address": "å—å¹³å¸‚æµ¦åŸå¿", "date_str": "6.30", "lat": 27.917804, "lng": 118.541079},
            {"address": "æµ¦åŸå¿çŸ³é™‚æ´¾å‡ºæ‰€", "date_str": "7.1", "lat": 27.698757, "lng": 118.37154}
        ];

        // 2. å…¨å±€å˜é‡
        let map, marker, infoWindow; // ç§»é™¤ pathLine
        let currentIndex = 0; // å½“å‰ä½ç½®ç´¢å¼•
        let isAnimating = false; // åŠ¨ç”»çŠ¶æ€
        let animationId = null; // åŠ¨ç”»ID
        let speed = 1; // åŠ¨ç”»é€Ÿåº¦
        let animationStartTime = 0; // åŠ¨ç”»å¼€å§‹æ—¶é—´
        let validCoords = []; // ç”¨äºå­˜å‚¨ç­›é€‰åçš„æœ‰æ•ˆä½ç½®æ•°æ®ï¼Œä¿ç•™åŸå§‹ä¿¡æ¯
        let pathLngLats = []; // ç”¨äºå­˜å‚¨ AMap.LngLat å¯¹è±¡ï¼Œä¾›åœ°å›¾APIä½¿ç”¨
        // ç§»é™¤é©¾è½¦è·¯çº¿è§„åˆ’æœåŠ¡å®ä¾‹å’Œç›¸å…³å˜é‡
        // let driving;
        // let currentSegmentDetailedPath = [];
        // let currentSegmentPathIndex = 0;
        // let routeCache = {};

        // ç”¨äºè½¨è¿¹çº¿é¢œè‰²çš„æ•°ç»„
        const traceColors = [
            '#FF0000', // çº¢è‰²
            '#00FF00', // ç»¿è‰²
            '#0000FF', // è“è‰²
            '#FFFF00', // é»„è‰²
            '#FF00FF', // å“çº¢
            '#00FFFF', // é’è‰²
            '#FFA500', // æ©™è‰²
            '#800080', // ç´«è‰²
            '#008000', // æ·±ç»¿
            '#4B0082'  // é›è“
        ];

        let completedPathSegments = []; // å­˜å‚¨å·²å®Œæˆçš„è½¨è¿¹æ®µ
        let currentAnimatingSegmentPolyline = null; // å­˜å‚¨å½“å‰æ­£åœ¨åŠ¨ç”»çš„è½¨è¿¹æ®µ

        // 3. åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            showStatus("æ­£åœ¨åŠ è½½åœ°å›¾...");
            
            if (!window.AMap || !AMapKey) {
                showStatus("é«˜å¾·APIæˆ–APIå¯†é’¥æœªè®¾ç½®ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œã€‚", true);
                return;
            }

            map = new AMap.Map('mapContainer', {
                zoom: 6,
                center: [116.39748, 39.908823], // åˆå§‹ä¸­å¿ƒç‚¹ï¼ˆåŒ—äº¬ï¼‰
                viewMode: '3D', // å¼€å¯3Dè§†å›¾
                pitch: 45, // ä¿¯è§†è§’åº¦
                rotation: 0,
                zooms: [3, 18], // é™åˆ¶ç¼©æ”¾èŒƒå›´
                showLabel: true // æ˜¾ç¤ºåœ°å›¾æ–‡å­—æ ‡è®°
            });

            map.on('complete', function() {
                console.log("åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶è§¦å‘ã€‚");
                showStatus("åœ°å›¾åŠ è½½å®Œæˆ");
                // ç¡®ä¿æ•°æ®å·²å‡†å¤‡å¥½
                if (locationData.length > 0) {
                    initPathAndMarker();
                } else {
                    showStatus("æ²¡æœ‰æœ‰æ•ˆçš„è½¨è¿¹æ•°æ®ã€‚", true);
                }
            });

            map.on('error', function(e) {
                console.error("åœ°å›¾åŠ è½½å¤±è´¥äº‹ä»¶è§¦å‘ï¼š", e);
                showStatus("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIå¯†é’¥ï¼š" + e.info, true);
            });

            // æ·»åŠ åœ°å›¾æ§ä»¶ (å·²é€šè¿‡pluginåŠ è½½ï¼Œç›´æ¥å®ä¾‹åŒ–)
            map.addControl(new AMap.ToolBar({
                position: 'RB' // å³ä¸‹è§’
            }));
            map.addControl(new AMap.Scale());

            // ç§»é™¤é©¾è½¦è·¯çº¿è§„åˆ’æœåŠ¡åˆå§‹åŒ–
            // AMap.plugin('AMap.Driving', function () {
            //     driving = new AMap.Driving({
            //         map: map,
            //         panel: '', 
            //         policy: AMap.Driving.ROAD_AND_TOLL, 
            //         autoFitView: false 
            //     });
            // });

            // åˆå§‹åŒ–æ ‡è®°ç‚¹
            marker = new AMap.Marker({
                icon: new AMap.Icon({
                    size: new AMap.Size(64, 64), // è°ƒæ•´å›¾æ ‡å¤§å°
                    // è¯·å°†æ‚¨çš„è­¦è½¦å¡é€šå›¾æ ‡æ–‡ä»¶æ”¾ç½®åœ¨ä¸ trace_web.html ç›¸åŒçš„ç›®å½•ä¸‹ï¼Œå¹¶ç¡®ä¿æ–‡ä»¶åæ­£ç¡®
                    image: './è­¦è½¦.png', // æ›¿æ¢ä¸ºæ‚¨çš„è­¦è½¦å›¾æ ‡æ–‡ä»¶å
                    imageSize: new AMap.Size(64, 64) // è°ƒæ•´å›¾æ ‡å›¾ç‰‡å¤§å°
                }),
                anchor: 'center', // æ ‡è®°ç‚¹å±…ä¸­
                autoRotation: false, // é‡æ–°è®¾ç½®ä¸º falseï¼Œå› ä¸º setRotation ä¸å¯ç”¨
                offset: new AMap.Pixel(0, -18), // å¾®è°ƒä½ç½®
                map: map
            });

            // é‡æ–°å®šä¹‰æ­£å¸¸å’Œç¿»è½¬çš„è­¦è½¦å›¾æ ‡
            window.policeCarIconNormal = new AMap.Icon({
                size: new AMap.Size(64, 64),
                image: './è­¦è½¦.png',
                imageSize: new AMap.Size(64, 64)
            });
            window.policeCarIconFlipped = new AMap.Icon({
                size: new AMap.Size(64, 64),
                image: './è­¦è½¦åè½¬.png', // ç¿»è½¬çš„è­¦è½¦å›¾æ ‡
                imageSize: new AMap.Size(64, 64)
            });

            // åˆå§‹è®¾ç½®å›¾æ ‡
            marker.setIcon(window.policeCarIconNormal);

            // ç§»é™¤åˆå§‹åŒ–è·¯å¾„çº¿ï¼Œå› ä¸ºå®ƒå°†åŠ¨æ€åˆ›å»º
            // pathLine = new AMap.Polyline({
            //     strokeColor: traceColors[0],
            //     strokeWeight: 4,
            //     strokeOpacity: 0.8,
            //     lineJoin: 'round',
            //     lineCap: 'round',
            //     zIndex: 50,
            //     map: map
            // });

            // åˆå§‹åŒ–ä¿¡æ¯çª—å£
            infoWindow = new AMap.InfoWindow({
                offset: new AMap.Pixel(0, -30),
                autoMove: true
            });
        }

        // æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰å·²ç»˜åˆ¶çš„è½¨è¿¹æ®µ
        function clearAllPathSegments() {
            if (currentAnimatingSegmentPolyline) {
                map.remove(currentAnimatingSegmentPolyline);
                currentAnimatingSegmentPolyline = null;
            }
            completedPathSegments.forEach(seg => {
                map.remove(seg);
            });
            completedPathSegments = [];
        }

        // 4. åˆå§‹åŒ–è·¯å¾„å’Œæ ‡è®°ç‚¹
        function initPathAndMarker() {
            console.log("å¼€å§‹åˆå§‹åŒ–è·¯å¾„å’Œæ ‡è®°ç‚¹...");
            console.log("åŸå§‹ä½ç½®æ•°æ® (locationData):", locationData);

            if (locationData.length === 0) {
                showStatus("æ²¡æœ‰æœ‰æ•ˆçš„è½¨è¿¹æ•°æ®ã€‚", true);
                return;
            }

            // è¿‡æ»¤æ‰æ²¡æœ‰ç»çº¬åº¦çš„æ— æ•ˆæ•°æ®ï¼Œå¹¶ç¡®ä¿ç»çº¬åº¦æ˜¯æµ®ç‚¹æ•°
            validCoords = locationData.filter(coord => coord.lng && coord.lat).map(coord => {
                const parsedLng = parseFloat(coord.lng);
                const parsedLat = parseFloat(coord.lat);
                if (isNaN(parsedLng) || isNaN(parsedLat)) {
                    console.error("å‘ç°æ— æ•ˆçš„ç»çº¬åº¦ï¼Œè·³è¿‡ï¼š", coord);
                    return null;
                }
                return { ...coord, lng: parsedLng, lat: parsedLat }; // è¿”å›åŒ…å«åŸå§‹æ•°æ®çš„æ‹·è´å’Œè§£æåçš„ç»çº¬åº¦
            }).filter(coord => coord !== null);

            console.log("æœ‰æ•ˆä½ç½®æ•°æ® (validCoords):", validCoords);

            if (validCoords.length === 0) {
                showStatus("æ‰€æœ‰åæ ‡å‡æ— æ•ˆã€‚", true);
                return;
            }

            // åˆ›å»º AMap.LngLat å¯¹è±¡çš„æ•°ç»„ï¼Œä¾›åœ°å›¾APIä½¿ç”¨
            pathLngLats = validCoords.map(coord => new AMap.LngLat(coord.lng, coord.lat));
            console.log("ç”¨äºè·¯å¾„å’Œæ ‡è®°ç‚¹çš„ AMap.LngLat æ•°ç»„ (pathLngLats):", pathLngLats);

            // ç¡®ä¿æ¸…é™¤æ‰€æœ‰ä»¥å‰çš„è½¨è¿¹æ®µ
            clearAllPathSegments();

            // ç§»åŠ¨æ ‡è®°åˆ°èµ·ç‚¹
            currentIndex = 0;
            const startCoordData = validCoords[currentIndex]; // ä» validCoords è·å–åŸå§‹æ•°æ®
            const startLngLat = pathLngLats[currentIndex];    // ä» pathLngLats è·å– AMap.LngLat å¯¹è±¡
            marker.setPosition(startLngLat);
            
            // æš‚æ—¶ç§»é™¤è¾¹ç•Œè®¡ç®—ï¼Œç›´æ¥è®¾ç½®ä¸­å¿ƒå’Œç¼©æ”¾
            map.setCenter(startLngLat);
            map.setZoom(10); // è®¾ç½®ä¸€ä¸ªåˆç†çš„åˆå§‹ç¼©æ”¾çº§åˆ«

            // æ˜¾ç¤ºèµ·ç‚¹ä¿¡æ¯çª—å£
            showInfoWindow(startCoordData); // ä¼ é€’åŒ…å« address å’Œ date_str çš„å¯¹è±¡

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        // 5. æ˜¾ç¤ºä¿¡æ¯çª—å£
        function showInfoWindow(coord) {
            const content = `<div style="padding:15px 20px; min-width:180px; max-width:250px; background: rgba(255, 255, 255, 0.95); border-radius:10px; box-shadow: 0 6px 20px rgba(0,0,0,0.18); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <div style="display:flex; align-items:center; margin-bottom:10px;">
                                    <span style="font-size:20px; color:#007bff; margin-right:8px;">ğŸ“</span>
                                    <h3 style="margin:0; font-size:16px; color:#333; font-weight:600; line-height:1.4;">${coord.address}</h3>
                                </div>
                                <div style="display:flex; align-items:center; border-top:1px solid #eee; padding-top:10px;">
                                    <span style="font-size:18px; color:#6c757d; margin-right:8px;">ğŸ“…</span>
                                    <p style="margin:0; color:#555; font-size:13px; font-weight:400;">æ—¥æœŸï¼š<span style="font-weight:600; color:#333;">${coord.date_str}</span></p>
                                </div>
                             </div>`;
            infoWindow.setContent(content);
            infoWindow.open(map, new AMap.LngLat(coord.lng, coord.lat));
        }

        // 6. åŠ¨ç”»é€»è¾‘
        function animate() {
            if (!isAnimating || currentIndex >= validCoords.length) { // Changed condition to >=
                if (currentIndex >= validCoords.length && isAnimating) { // åŠ¨ç”»è‡ªç„¶ç»“æŸ
                    isAnimating = false;
                    showStatus("åŠ¨ç”»å·²å®Œæˆï¼", false);
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('pauseBtn').disabled = true;
                    // ç¡®ä¿æœ€åä¸€ä¸ªåŠ¨ç”»æ®µè¢«å®Œæ•´æ·»åŠ åˆ°å·²å®Œæˆåˆ—è¡¨
                    if (currentAnimatingSegmentPolyline) {
                        // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ currentIndex - 1 ä½œä¸ºæœ€åä¸€ä¸ªå·²å®Œæˆæ®µçš„èµ·ç‚¹ï¼ŒcurrentIndex ä½œä¸ºç»ˆç‚¹
                        // å› ä¸ºå½“ currentIndex >= validCoords.length æ—¶ï¼Œå‰ä¸€ä¸ª currentIndex æ‰æ˜¯æœ€åä¸€ä¸ªç‚¹çš„ç´¢å¼•ã€‚
                        const lastSegmentStart = pathLngLats[currentIndex - 1]; 
                        const lastSegmentEnd = pathLngLats[currentIndex - 1]; // ä¿®æ­£ï¼Œè¿™é‡Œåº”è¯¥æ˜¯æœ€åä¸€ä¸ªæœ‰æ•ˆçš„ç‚¹
                        currentAnimatingSegmentPolyline.setPath([lastSegmentStart, lastSegmentEnd]);
                        completedPathSegments.push(currentAnimatingSegmentPolyline);
                        currentAnimatingSegmentPolyline = null;
                    }
                }
                return;
            }

            const startLngLatOfCurrentAnimatingSegment = pathLngLats[currentIndex];
            const endLngLatOfCurrentAnimatingSegment = pathLngLats[currentIndex + 1]; // This can be undefined if it's the very last point

            // å¦‚æœæ˜¯æœ€åä¸€ä¸ªç‚¹ï¼Œæ²¡æœ‰ä¸‹ä¸€æ®µè¦åŠ¨ç”»
            if (!endLngLatOfCurrentAnimatingSegment) {
                // ç¡®ä¿æ ‡è®°å·²åœ¨æœ€ç»ˆä½ç½®
                marker.setPosition(startLngLatOfCurrentAnimatingSegment);
                // ç¡®ä¿æœ€åä¸€ä¸ªåŠ¨ç”»æ®µè¢«å®Œæ•´æ·»åŠ åˆ°å·²å®Œæˆåˆ—è¡¨
                if (currentAnimatingSegmentPolyline) {
                    const finalSegmentStart = pathLngLats[currentIndex - 1];
                    const finalSegmentEnd = pathLngLats[currentIndex]; // åŠ¨ç”»çš„æœ€åä¸€ä¸ªç‚¹
                    currentAnimatingSegmentPolyline.setPath([finalSegmentStart, finalSegmentEnd]);
                    completedPathSegments.push(currentAnimatingSegmentPolyline);
                    currentAnimatingSegmentPolyline = null;
                }
                // åœæ­¢åŠ¨ç”»
                isAnimating = false;
                showStatus("åŠ¨ç”»å·²å®Œæˆï¼", false);
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = true;
                cancelAnimationFrame(animationId);
                animationId = null;
                return;
            }


            const baseDuration = 5000; // æ¯ä¸ªåŠ¨ç”»æ®µé»˜è®¤5ç§’
            const duration = baseDuration / speed; 
            const elapsed = Date.now() - animationStartTime;
            let progress = elapsed / duration;

            if (progress >= 1) { // å½“å‰æ®µåŠ¨ç”»å®Œæˆï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€æ®µ
                // ç¡®è®¤å½“å‰åŠ¨ç”»æ®µå·²å®Œå…¨ç»˜åˆ¶å¹¶æ·»åŠ åˆ°å·²å®Œæˆåˆ—è¡¨
                if (currentAnimatingSegmentPolyline) {
                    currentAnimatingSegmentPolyline.setPath([startLngLatOfCurrentAnimatingSegment, endLngLatOfCurrentAnimatingSegment]);
                    completedPathSegments.push(currentAnimatingSegmentPolyline);
                    currentAnimatingSegmentPolyline = null; // ä¸ºä¸‹ä¸€æ®µé‡ç½®
                }

                currentIndex++;
                animationStartTime = Date.now(); // é‡ç½®è®¡æ—¶å™¨
                progress = 0; // é‡ç½®è¿›åº¦

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šè½¨è¿¹æ®µè¦åŠ¨ç”»
                if (currentIndex < validCoords.length - 1) {
                    showInfoWindow(validCoords[currentIndex]);

                    // ä¸ºæ–°çš„è½¨è¿¹æ®µï¼ˆä» pathLngLats[currentIndex] åˆ° pathLngLats[currentIndex + 1]ï¼‰ç¡®å®šæ–¹å‘
                    const newSegmentStart = pathLngLats[currentIndex];
                    const newSegmentEnd = pathLngLats[currentIndex + 1];
                    const deltaLng = newSegmentEnd.lng - newSegmentStart.lng;

                    if (deltaLng < 0) { // å‘è¥¿ï¼ˆå·¦ï¼‰ç§»åŠ¨
                        marker.setIcon(window.policeCarIconNormal);
                    } else if (deltaLng > 0) { // å‘ä¸œï¼ˆå³ï¼‰ç§»åŠ¨
                        marker.setIcon(window.policeCarIconFlipped);
                    }
                    // å¦‚æœç»åº¦æ²¡æœ‰å˜åŒ–ï¼Œå›¾æ ‡ä¿æŒä¸å˜

                    // ä¸ºæ–°è½¨è¿¹æ®µåˆ›å»ºæ–°çš„ Polyline
                    currentAnimatingSegmentPolyline = new AMap.Polyline({
                        strokeColor: traceColors[currentIndex % traceColors.length], // æ–°è½¨è¿¹æ®µçš„é¢œè‰²
                        strokeWeight: 4,
                        strokeOpacity: 0.8,
                        lineJoin: 'round',
                        lineCap: 'round',
                        zIndex: 50,
                        map: map,
                        path: [newSegmentStart] // ä»æ–°è½¨è¿¹æ®µçš„èµ·ç‚¹å¼€å§‹
                    });
                } else { // è¿™è¡¨ç¤º currentIndex ç°åœ¨æ˜¯ validCoords.length - 1ï¼ˆæœ€åä¸€ä¸ªç‚¹ï¼‰
                    // æ²¡æœ‰æ›´å¤šè½¨è¿¹æ®µè¦åŠ¨ç”»ã€‚åŠ¨ç”»å°†åœ¨åˆ°è¾¾æ­¤ç‚¹ååœæ­¢ã€‚
                    // æ ‡è®°å°†ç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®ã€‚å›¾æ ‡åº”ä¿æŒä¸Šä¸€ä¸ªå·²å®Œæˆè½¨è¿¹æ®µçš„æ–¹å‘ã€‚
                    currentAnimatingSegmentPolyline = null; // ç¡®ä¿ä¸º nullï¼Œå› ä¸ºæ²¡æœ‰æ–°è½¨è¿¹æ®µæ­£åœ¨åŠ¨ç”»
                }
            }
            
            // æ²¿å½“å‰è½¨è¿¹æ®µæ’å€¼ä½ç½®
            const easeProgress = easeInOutCubic(progress);
            const lng = startLngLatOfCurrentAnimatingSegment.lng + (endLngLatOfCurrentAnimatingSegment.lng - startLngLatOfCurrentAnimatingSegment.lng) * easeProgress;
            const lat = startLngLatOfCurrentAnimatingSegment.lat + (endLngLatOfCurrentAnimatingSegment.lat - startLngLatOfCurrentAnimatingSegment.lat) * easeProgress;

            if (isNaN(lng) || isNaN(lat)) {
                console.error("[Animate Error] æ’å€¼åçš„åæ ‡ä¸º NaNï¼åœæ­¢åŠ¨ç”»ã€‚", { lng, lat, startLngLatOfCurrentAnimatingSegment, endLngLatOfCurrentAnimatingSegment, progress, easeProgress });
                isAnimating = false;
                cancelAnimationFrame(animationId);
                animationId = null;
                showStatus("åŠ¨ç”»å› æ’å€¼åæ ‡æ— æ•ˆè€Œåœæ­¢ã€‚", true);
                return;
            }

            const currentPosition = new AMap.LngLat(lng, lat);
            marker.setPosition(currentPosition);

            // æ›´æ–°å½“å‰åŠ¨ç”»è½¨è¿¹æ®µçš„è·¯å¾„
            if (currentAnimatingSegmentPolyline) {
                currentAnimatingSegmentPolyline.setPath([startLngLatOfCurrentAnimatingSegment, currentPosition]);
            }

            animationId = requestAnimationFrame(animate);
        }

        // ç¼“åŠ¨å‡½æ•°ï¼ˆä½¿åŠ¨ç”»æ›´è‡ªç„¶ï¼‰
        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // ç§»é™¤å¼‚æ­¥å‡½æ•°ï¼šè§„åˆ’ä¸‹ä¸€ä¸ªä¸»æ®µçš„è·¯çº¿å¹¶å¼€å§‹/ç»§ç»­åŠ¨ç”»
        // function planNextSegmentAndAnimate() { /* ... ç§»é™¤æ­¤å‡½æ•° ... */ }


        // 7. æ§åˆ¶å‡½æ•°
        function startAnimation() {
            // å¦‚æœå·²ç»åœ¨åŠ¨ç”»ä¸­æˆ–å°‘äº2ä¸ªç‚¹ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            if (isAnimating || validCoords.length < 2) return;
            
            isAnimating = true;
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¼€å§‹æˆ–ä»é‡ç½®åå¼€å§‹ï¼Œé‡ç½®è®¡æ—¶å™¨å¹¶åˆ›å»ºç¬¬ä¸€ä¸ªåŠ¨ç”»æ®µ
            if (animationId === null || currentIndex === 0) { 
                animationStartTime = Date.now();
                if (validCoords.length > 1) { // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè½¨è¿¹æ®µ
                    // ä¸ºç¬¬ä¸€ä¸ªè½¨è¿¹æ®µè®¾ç½®å›¾æ ‡æ–¹å‘
                    const firstSegmentStart = pathLngLats[0];
                    const firstSegmentEnd = pathLngLats[1];
                    const deltaLng = firstSegmentEnd.lng - firstSegmentStart.lng;

                    if (deltaLng < 0) { // å‘è¥¿ï¼ˆå·¦ï¼‰ç§»åŠ¨
                        marker.setIcon(window.policeCarIconNormal);
                    } else if (deltaLng > 0) { // å‘ä¸œï¼ˆå³ï¼‰ç§»åŠ¨
                        marker.setIcon(window.policeCarIconFlipped);
                    }
                    // å¦‚æœç»åº¦æ²¡æœ‰å˜åŒ–ï¼Œä¿æŒåˆå§‹å›¾æ ‡

                    currentAnimatingSegmentPolyline = new AMap.Polyline({
                        strokeColor: traceColors[0], // ç¬¬ä¸€ä¸ªè½¨è¿¹æ®µçš„é¢œè‰²
                        strokeWeight: 4,
                        strokeOpacity: 0.8,
                        lineJoin: 'round',
                        lineCap: 'round',
                        zIndex: 50,
                        map: map,
                        path: [firstSegmentStart] // åˆå§‹è·¯å¾„åªåŒ…å«èµ·ç‚¹
                    });
                }
            }
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            showStatus("åŠ¨ç”»å·²å¼€å§‹");
            
            // å¯åŠ¨åŠ¨ç”»å¾ªç¯
            animationId = requestAnimationFrame(animate);
        }

        function pauseAnimation() {
            if (!isAnimating) return;
            
            isAnimating = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            showStatus("åŠ¨ç”»å·²æš‚åœ");
        }

        function resetAnimation() {
            pauseAnimation();
            currentIndex = 0;
            // ç§»é™¤é‡ç½®æ—¶æ¸…é™¤è¯¦ç»†è·¯å¾„å’Œç¼“å­˜
            // currentSegmentDetailedPath = []; 
            // currentSegmentPathIndex = 0; 
            // routeCache = {}; 

            // æ¸…é™¤æ‰€æœ‰å·²ç»˜åˆ¶çš„è½¨è¿¹æ®µ
            clearAllPathSegments();

            // ä½¿ç”¨ validCoords å’Œ pathLngLats è¿›è¡Œé‡ç½®
            if (validCoords.length > 0) {
                const firstCoordData = validCoords[0];
                const firstLngLat = pathLngLats[0];
                marker.setPosition(firstLngLat);
                map.setCenter(firstLngLat);
                showInfoWindow(firstCoordData);
                // é‡ç½®è­¦è½¦å›¾æ ‡ä¸ºé»˜è®¤ï¼ˆå‘å·¦ï¼‰
                marker.setIcon(window.policeCarIconNormal);
            }
            
            // ç§»é™¤é‡ç½®è½¨è¿¹çº¿é¢œè‰²ï¼Œå› ä¸ºæ¯ä¸ªæ®µéƒ½æœ‰è‡ªå·±çš„é¢œè‰²
            // pathLine.setOptions({
            //     strokeColor: traceColors[0]
            // });
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            showStatus("åŠ¨ç”»å·²é‡ç½®");
        }

        // 8. é€Ÿåº¦æ§åˆ¶
        document.getElementById('speedControl').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = `${speed.toFixed(1)}x`;
            
            // å¦‚æœæ­£åœ¨åŠ¨ç”»ï¼Œé‡ç½®è®¡æ—¶å™¨ä»¥ç«‹å³åº”ç”¨æ–°é€Ÿåº¦
            if (isAnimating) {
                animationStartTime = Date.now(); 
            }
        });

        // 9. çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤º
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            if (isError) {
                statusElement.style.backgroundColor = 'rgba(255, 85, 85, 0.9)';
            } else {
                statusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
            }
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 10. é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html> 